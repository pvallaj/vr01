<a id="marcaNarrativas" #marcaNarrativas></a>
<div class="marco" fxFlex fxLayout="column" fxLayoutAlign="center" fxFill fxLayoutAlign="space-around stretch">

    <form [formGroup]="frm" class="consulta" fxfill fxLayout.lt-sm="column" fxLayout="row">
        <div class="defconsulta" fxFlex="80" fxFlex.lt-sm="100" fxLayout="row wrap" fxLayoutGap="10px" fxLayoutAlign="start center">

            <mat-form-field appearance="fill" *ngIf="filtrosActivos.value.indexOf('Autor')>=0 && filtrosActivos.value.indexOf('Obra')>=0" fxFlex="0 0 calc(25% - 10px)" fxFlex.lt-md="0 0 calc(50% - 10px)" fxFlex.lt-sm="100%">
                <mat-label>Seleccione un autor</mat-label>
                <mat-select name="autor" formControlName="autor" (selectionChange)="autorSeleccionado($event)">
                    <mat-option>Ninguno</mat-option>
                    <mat-option *ngFor="let autor of listaAutores" [value]="autor.autor">
                        {{autor.autor}}
                    </mat-option>
                </mat-select>
            </mat-form-field>

            <mat-form-field appearance="fill" *ngIf="filtrosActivos.value.indexOf('Autor')>=0  && filtrosActivos.value.indexOf('Obra')==-1" fxFlex="0 0 calc(25% - 10px)" fxFlex.lt-md="0 0 calc(50% - 10px)" fxFlex.lt-sm="100%">
                <mat-label>Seleccione un autor</mat-label>
                <mat-select [formControl]="fcAutores" multiple>
                    <mat-select-trigger>
                        {{fcAutores.value ? fcAutores.value[0] : ''}}
                        <span *ngIf="fcAutores.value?.length > 1">
                        (+{{fcAutores.value.length - 1}} {{fcAutores.value?.length === 2 ? 'otro' : 'otros'}})
                        </span>
                    </mat-select-trigger>
                    <mat-option *ngFor="let autor of listaAutores" [value]="autor.autor">
                        {{autor.autor}}
                    </mat-option>
                </mat-select>
            </mat-form-field>

            <mat-form-field appearance="fill" *ngIf="filtrosActivos.value.indexOf('Obra')>=0  && filtrosActivos.value.indexOf('Obra')>0" fxFlex="0 0 calc(25% - 10px)" fxFlex.lt-md="0 0 calc(50% - 10px)" fxFlex.lt-sm="100%">
                <mat-label>Seleccione una obra</mat-label>
                <mat-select name="obra" formControlName="obra">
                    <mat-option>Ninguno</mat-option>
                    <mat-option *ngFor="let obra of listaObras" [value]="obra.obra">
                        {{obra.obra}}
                    </mat-option>
                </mat-select>
            </mat-form-field>

            <mat-form-field appearance="fill" *ngIf="filtrosActivos.value.indexOf('Obra')>=0  && filtrosActivos.value.indexOf('Autor')==-1" fxFlex="0 0 calc(25% - 10px)" fxFlex.lt-md="0 0 calc(50% - 10px)" fxFlex.lt-sm="100%">
                <mat-label>Seleccione una o más obras</mat-label>
                <mat-select [formControl]="fcObras" multiple>
                    <mat-select-trigger>
                        {{fcObras.value ? fcObras.value[0] : ''}}
                        <span *ngIf="fcObras.value?.length > 1">
                        (+{{fcObras.value.length - 1}} {{fcObras.value?.length === 2 ? 'otro' : 'otros'}})
                        </span>
                    </mat-select-trigger>
                    <mat-option *ngFor="let obra of listaObras" [value]="obra.obra">
                        {{obra.obra}}
                    </mat-option>
                </mat-select>
            </mat-form-field>

            <mat-form-field appearance="fill" *ngIf="filtrosActivos.value.indexOf('Clasificación')>=0" fxFlex="0 0 calc(25% - 10px)" fxFlex.lt-md="0 0 calc(50% - 10px)" fxFlex.lt-sm="100%">
                <mat-label>Seleccione una ubicación temporal</mat-label>
                <mat-select name="clase" formControlName="clasificacion">
                    <mat-option>Ninguno</mat-option>
                    <mat-option *ngFor="let categoria of listaClasificacion" [value]="categoria.id" matTooltip="{{categoria.categoria}}">
                        {{categoria.categoria}}
                    </mat-option>
                </mat-select>
            </mat-form-field>

            <mat-form-field appearance="fill" *ngIf="filtrosActivos.value.indexOf('Tema')>=0" fxFlex="0 0 calc(25% - 10px)" fxFlex.lt-md="0 0 calc(50% - 10px)" fxFlex.lt-sm="100%">
                <mat-label>Seleccione una tema</mat-label>
                <mat-select name="clase" formControlName="tema">
                    <mat-option>Ninguno</mat-option>
                    <mat-option *ngFor="let elemento of listaTemas" [value]="elemento.idpalabra" matTooltip="{{elemento.palabra}}">
                        {{elemento.palabra}}
                    </mat-option>
                </mat-select>
            </mat-form-field>

            <mat-form-field appearance="fill" *ngIf="filtrosActivos.value.indexOf('Motivo')>=0" fxFlex="0 0 calc(25% - 10px)" fxFlex.lt-md="0 0 calc(50% - 10px)" fxFlex.lt-sm="100%">
                <mat-label>Seleccione un motivo</mat-label>
                <mat-select name="clase" formControlName="motivo">
                    <mat-option>Ninguno</mat-option>
                    <mat-option *ngFor="let elemento of listaMotivos" [value]="elemento.id_motivo" matTooltip="{{elemento.motivo}}">
                        {{elemento.motivo}}
                    </mat-option>
                </mat-select>
            </mat-form-field>

            <mat-form-field appearance="fill" *ngIf="filtrosActivos.value.indexOf('Tipo de Verso')>=0" fxFlex="0 0 calc(25% - 10px)" fxFlex.lt-md="0 0 calc(50% - 10px)" fxFlex.lt-sm="100%">
                <mat-label>Seleccione un Tipo de Verso</mat-label>
                <mat-select name="clase" formControlName="tipoVerso">
                    <mat-option>Ninguno</mat-option>
                    <mat-option *ngFor="let elemento of listaVersificaciones" [value]="elemento.id_versificacion" matTooltip="{{elemento.tipo_verso}}">
                        {{elemento.tipo_verso}}
                    </mat-option>
                </mat-select>
            </mat-form-field>

            <mat-form-field appearance="fill" *ngIf="filtrosActivos.value.indexOf('Tipo de Acción')>=0" fxFlex="0 0 calc(25% - 10px)" fxFlex.lt-md="0 0 calc(50% - 10px)" fxFlex.lt-sm="100%">
                <mat-label>Seleccione un Tipo de Acción</mat-label>
                <mat-select name="clase" formControlName="tipoAccion">
                    <mat-option>Ninguno</mat-option>
                    <mat-option *ngFor="let elemento of listaTipoAcciones" [value]="elemento.id_tipo_accion" matTooltip="{{elemento.descripcion}}">
                        {{elemento.tipo_accion}}
                    </mat-option>
                </mat-select>
            </mat-form-field>

            <mat-form-field appearance="fill" *ngIf="filtrosActivos.value.indexOf('Soporte')>=0" fxFlex="0 0 calc(25% - 10px)" fxFlex.lt-md="0 0 calc(50% - 10px)" fxFlex.lt-sm="100%">
                <mat-label>Seleccione un Tipo de Soporte</mat-label>
                <mat-select name="clase" formControlName="soporte">
                    <mat-option>Ninguno</mat-option>
                    <mat-option *ngFor="let elemento of listaSoporte" [value]="elemento.id_soporte" matTooltip="{{elemento.tipo_material}}">
                        {{elemento.tipo_material}}
                    </mat-option>
                </mat-select>
            </mat-form-field>

            <mat-form-field *ngIf="filtrosActivos.value.indexOf('Textos o Palabras')>=0" fxFlex="0 0 calc(25% - 10px)" fxFlex.lt-md="0 0 calc(50% - 10px)" fxFlex.lt-sm="100%">
                <mat-label>Buscan de palabras o textos</mat-label>
                <input matInput type="text" formControlName="textos" name="textosPalabras" [(ngModel)]="vTextos">
                <button mat-button matSuffix mat-icon-button (click)="vTextos=''">
                    <mat-icon>close</mat-icon>
                </button>
            </mat-form-field>
            <mat-form-field appearance="fill" *ngIf="filtrosActivos.value.indexOf('Textos o Palabras')>=0" fxFlex="0 0 calc(25% - 10px)" fxFlex.lt-md="0 0 calc(50% - 10px)" fxFlex.lt-sm="100%">
                <mat-label>Distancia entre palabras</mat-label>
                <mat-select name="distancia" formControlName="distancia">
                    <mat-option *ngFor="let d of listaDistancias" [value]="d">
                        {{d}}
                    </mat-option>
                </mat-select>
            </mat-form-field>

        </div>
        <div fxLayout="column" fxFlex fxLayoutAlign="space-between stretch" fxLayoutGap="15px">
            <button *ngIf="listaResultadoSA==null && listaResultadoV==null && listaResultadoC==null" mat-raised-button (click)="abrirBusquedaAvanzada()">
                <mat-icon>settings</mat-icon> Busqueda Avanzada
            </button>
            <button *ngIf="listaResultadoSA!=null || listaResultadoV!=null || listaResultadoC!=null" mat-raised-button (click)="abrirBusquedaAvanzada()">
                <mat-icon>settings</mat-icon> Regresar a busqueda por parametros
            </button>
            <button mat-raised-button *ngIf="!filtroActivo('Signos Actorales') && !filtroActivo('Vinculos')  && !filtroActivo('Contexto')" (click)="consulta()">
                <mat-icon>search</mat-icon> BUSCAR
            </button>
        </div>
    </form>
    <mat-card class="buscando" *ngIf="estaCargando">
        <mat-card-content>
            <h2 class="example-h2">Consultando base de datos de RELACIONES</h2>

            <section class="example-section">
                <mat-progress-bar class="example-margin" [color]="'primary'" [mode]="'indeterminate'" [value]="50" [bufferValue]="100">
                </mat-progress-bar>
            </section>
        </mat-card-content>
    </mat-card>
    <div class="resultado" *ngIf="!estaCargando && listaResultado!=null" fxFill>
        <h3 *ngIf="listaResultado!=null && listaResultado.length>0">Información encontrada en la base de datos de RELACIONES (se muestran {{listaResultado.length}} de {{totalRegistros}} existentes.)</h3>
        <h3 *ngIf="listaResultado.length==0">No se encontró información con los parametros proporcionados. Intente con otros datos.</h3>
        <div class="lista-resultado" fxLayout="row wrap" fxLayout.lt-sm="column" fxLayoutGap="20px" fxLayoutAlign="start">
            <div class="tarjeta" (click)="cambiar(narrativa)" *ngFor="let narrativa of listaResultado; let i = index" fxFlex="0 0 calc(24% - 10px)" fxFlex.lt-md="0 0 calc(50% - 10px)" fxFlex.lt-sm="100%">
                <div class="encabezado">
                    <div class="titulo">{{narrativa.autor }}</div>
                    <div class="subtitulo">{{narrativa.obra+', '+narrativa.ubicacion}}</div>
                </div>
                <div class="contenido">
                    <div [innerHTML]="narrativa.narratioRecortado | resaltaTexto:frm.value.textos"></div>
                </div>
                <!--div>
                    <button class="btnDetalle" mat-flat-button color="primary" (click)="cambiar(narrativa)">
                        <mat-icon>article</mat-icon> Ver Detalle
                    </button>
                </div-->
            </div>

        </div>
    </div>

    <app-mapa-signos *ngIf="listaResultadoSA!=null" [datos]="listaResultadoSA"></app-mapa-signos>
    <app-mapa-vinculos *ngIf="listaResultadoV!=null" [datos]="listaResultadoV"></app-mapa-vinculos>
    <app-mapa-contexto *ngIf="listaResultadoC!=null" [datos]="listaResultadoC"></app-mapa-contexto>

</div>
<!--div class="detalle" *ngIf="desplegarDetalle">
    <button mat-flat-button color="primary" (click)="cambiar(null)">
        <mat-icon>arrow_back_ios</mat-icon> <mat-icon>arrow_back_ios</mat-icon> Regresar
    </button>
    <app-cons-det-narrativa [idTexto]="idNarrativaSel" [narrativa]="narrativaSeleccionada" [textoBuscado]="frm.value.textos"></app-cons-det-narrativa>
</div-->
<app-tc *ngIf="idNarrativaSel!=0" [referencia]="idNarrativaSel" [tipo]="'relacion'" [textoBuscado]="frm.value.textos" (quitar)="cerrarDetalle()">

</app-tc>